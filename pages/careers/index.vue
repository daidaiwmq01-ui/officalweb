<template>
  <div class="min-h-screen bg-white font-['Noto_Sans_SC']">
    <!-- ğŸš€ Hero Section: The Visionary Call -->
    <section class="relative h-[500px] overflow-hidden bg-gradient-to-b from-[#0B2747] to-[#111827]">
      <div class="absolute inset-0 opacity-20">
        <ImageWithFallback
          src="/image/about/hero.webp"
          alt="åŠ å…¥è½¦æ‹–è½¦å›¢é˜Ÿ - åˆ›é€ æ•°å­—åŒ–ç‰©æµæœªæ¥"
        loading="eager"
          class="w-full h-full object-cover"
        />
      </div>
      <div class="absolute inset-0 z-0 bg-[radial-gradient(#ffffff10_1px,transparent_1px)] [background-size:40px_40px]" />

      <div class="container mx-auto max-w-[1200px] px-4 lg:px-0 relative z-10 text-center h-full flex flex-col justify-center">
        <!-- Breadcrumb - Top Left Fixed -->
        <div class="absolute top-6 left-4 lg:left-0 z-20">
          <BreadcrumbNav :items="breadcrumbItems" variant="light" />
        </div>

        <h1
          v-motion
          :initial="{ opacity: 0, y: 20 }"
          :enter="{ opacity: 1, y: 0 }"
          class="text-2xl sm:text-3xl md:text-[48px] font-bold text-white mb-6 leading-[1.6] mt-16"
        >
          åŠ å…¥æˆ‘ä»¬ï¼Œè¿æ¥æ±½è½¦ç‰©æµçš„ä¸‹ä¸€ä¸ªæ—¶ä»£
        </h1>
        <p
          v-motion
          :initial="{ opacity: 0, y: 20 }"
          :enter="{ opacity: 1, y: 0, transition: { delay: 100 } }"
          class="text-[18px] text-white/70 max-w-[800px] mx-auto mb-10 leading-relaxed"
        >
          è½¦æ‹–è½¦æ­£è‡´åŠ›äºæ„å»ºä¸€ä¸ªæ›´é€æ˜ã€æ›´é«˜æ•ˆçš„æ•°å­—åŒ–ç‰©æµç”Ÿæ€ç³»ç»Ÿã€‚æˆ‘ä»¬å¯»æ‰¾å¯¹æŠ€æœ¯å……æ»¡çƒ­å¿±ã€å‹‡äºæŒ‘æˆ˜è¡Œä¸šç—›ç‚¹çš„åˆ›æ–°è€…ã€‚
        </p>

        <div
          v-motion
          :initial="{ opacity: 0, y: 20 }"
          :enter="{ opacity: 1, y: 0, transition: { delay: 200 } }"
          class="max-w-[600px] mx-auto relative group"
        >
          <div class="absolute inset-y-0 left-6 flex items-center pointer-events-none">
            <Search class="w-5 h-5 text-gray-400 group-focus-within:text-[#006EFF] transition-colors" />
          </div>
          <Input
            v-model="searchQuery"
            placeholder="æœç´¢èŒä½å…³é”®è¯ (å¦‚ï¼šJava, äº§å“ç»ç†)..."
            class="w-full h-14 pl-14 pr-32 rounded-2xl bg-white/10 border-white/20 text-white placeholder:text-white/40 focus:bg-white focus:text-[#0B2747] transition-all"
          />
          <Button class="absolute right-2 top-2 h-10 px-6 bg-[#FF6B00] hover:bg-[#E56000] text-white rounded-xl border-none font-bold">
            æœç´¢èŒä½
          </Button>
        </div>
      </div>
    </section>

    <!-- ğŸ¢ Section A: Employee Value Proposition (EVP) -->
    <section class="py-24 bg-white">
      <div class="container mx-auto max-w-[1200px] px-4">
        <div class="text-center mb-16">
          <h2 class="text-[32px] font-bold text-[#0B2747] mb-4">
            åœ¨è½¦æ‹–è½¦å·¥ä½œæ˜¯æ€æ ·çš„ä½“éªŒï¼Ÿ
          </h2>
          <div class="w-16 h-1 bg-[#FF6B00] mx-auto rounded-full" />
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
          <div
            v-for="(item, idx) in evpItems"
            :key="idx"
            class="p-10 rounded-[32px] border border-gray-100 hover:shadow-xl transition-all group"
            :class="item.bgClass"
          >
            <div :class="['w-16 h-16 rounded-2xl flex items-center justify-center mb-8 transition-all', item.iconBgClass]">
              <component :is="item.icon" class="w-8 h-8" :class="item.iconClass" />
            </div>
            <h3 class="text-[22px] font-bold text-[#0B2747] mb-4">
              {{ item.title }}
            </h3>
            <p class="text-gray-500 leading-relaxed">
              {{ item.desc }}
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- ğŸ“ Section B: Campus Recruitment -->
    <section class="py-24 bg-[#F0F7FF]">
      <div class="container mx-auto max-w-[1200px] px-4">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-16 items-center">
          <div
            v-motion
            :initial="{ opacity: 0, x: -30 }"
            :visible="{ opacity: 1, x: 0 }"
            :visibleOnce="true"
          >
            <h2 class="text-2xl sm:text-[36px] font-bold text-[#0B2747] mb-6">
              æ ¡æ‹›ä¸“é¡¹ï¼šâ€˜æ™ºè¿ç”Ÿâ€™è®¡åˆ’
            </h2>
            <div class="space-y-6 text-gray-600 leading-relaxed text-[16px]">
              <p>
                â€˜æ™ºè¿ç”Ÿâ€™è®¡åˆ’æ˜¯è½¦æ‹–è½¦é¢å‘å…¨çƒä¼˜ç§€é«˜æ ¡æ¯•ä¸šç”Ÿçš„æ ¸å¿ƒäººæ‰åŸ¹å…»æˆ˜ç•¥ã€‚æˆ‘ä»¬æ—¨åœ¨é€šè¿‡ä¸¤å¹´çš„"å¯¼å¸ˆåˆ¶"è½®å²—è½®è®­ï¼ŒåŸ¹å…»å‡ºæ—¢æ‡‚ä¸šåŠ¡é€»è¾‘ã€åˆæ‡‚å‰æ²¿æŠ€æœ¯çš„å¤åˆå‹ç‰©æµç§‘æŠ€é¢†å†›äººæ‰ã€‚
              </p>
              <p>
                åœ¨è¿™é‡Œï¼Œä½ ä¸æ˜¯æ—è§‚è€…ï¼Œè€Œæ˜¯è§„åˆ™çš„åˆ¶å®šè€…ã€‚ä½ å°†å‚ä¸åˆ°æ”¯æ’‘å¹´
                GMV 43
                äº¿è§„æ¨¡çš„ç³»ç»Ÿå¼€å‘ä¸­ï¼Œä¸è¡Œä¸šå…±åŒå®šä¹‰æ•°å­—åŒ–æ‰˜è¿çš„æ ‡å‡†ã€‚
              </p>
            </div>

            <div class="flex flex-wrap gap-3 mt-10">
              <span
                v-for="tag in ['å®ä¹ ç”Ÿæ‹›è˜', 'åº”å±Šç”Ÿ', 'äº¤é€šç‰©æµ', 'ä¿¡æ¯å®‰å…¨']"
                :key="tag"
                class="px-4 py-2 bg-white rounded-full text-[14px] font-medium text-[#006EFF] border border-blue-100 shadow-sm"
              >
                {{ tag }}
              </span>
            </div>

            <Button class="mt-12 h-14 px-10 border-[#006EFF] text-[#006EFF] hover:bg-[#006EFF] hover:text-white rounded-2xl font-bold transition-all">
              æŸ¥çœ‹æ ¡æ‹›å²—ä½
            </Button>
          </div>

          <div
            v-motion
            :initial="{ opacity: 0, scale: 0.95 }"
            :visible="{ opacity: 1, scale: 1 }"
            :visibleOnce="true"
            class="relative rounded-[40px] overflow-hidden shadow-2xl"
          >
            <ImageWithFallback
              src="/image/partner-recruit/hero.webp"
              alt="è½¦æ‹–è½¦ç ”å‘å›¢é˜Ÿå·¥ä½œç°åœº"
              class="w-full h-[500px] object-cover"
            />
            <div class="absolute inset-0 bg-gradient-to-t from-[#0B2747]/60 to-transparent" />
            <div class="absolute bottom-10 left-10">
              <div class="bg-white/20 backdrop-blur-md px-6 py-4 rounded-2xl border border-white/20">
                <div class="text-white text-[14px] font-medium">
                  2026 å±Šâ€˜æ™ºè¿ç”Ÿâ€™ç§‹æ‹›æ­£å¼å¼€å¯
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ğŸ’¼ Section C: Open Positions -->
    <section class="py-24 bg-white" id="positions">
      <div class="container mx-auto max-w-[1200px] px-4">
        <div class="text-center mb-16">
          <h2 class="text-[32px] font-bold text-[#0B2747] mb-4">
            çƒ­æ‹›å²—ä½
          </h2>
          <div class="w-16 h-1 bg-[#FF6B00] mx-auto rounded-full" />
        </div>

        <div class="w-full">
          <div v-if="tabs && tabs.length > 0" class="flex flex-wrap justify-center gap-4 bg-transparent mb-12">
            <button
              v-for="tab in tabs"
              :key="tab.value"
              :class="[
                'px-8 py-3 rounded-xl border transition-all shadow-sm',
                activeTab === tab.value
                  ? 'bg-[#006EFF] text-white border-transparent'
                  : 'border-gray-100 bg-gray-50 text-gray-500 hover:bg-gray-100'
              ]"
              @click="activeTab = tab.value"
            >
              {{ tab.label }}
            </button>
          </div>

          <div class="space-y-6">
            <!-- Loading çŠ¶æ€ -->
            <div v-if="loading" class="space-y-6">
              <div v-for="i in 3" :key="i" class="p-8 rounded-[32px] bg-gray-50 animate-pulse">
                <div class="h-6 bg-gray-200 rounded w-2/3 mb-4" />
                <div class="h-4 bg-gray-200 rounded w-1/2 mb-2" />
                <div class="h-4 bg-gray-200 rounded w-3/4" />
              </div>
            </div>
            
            <!-- èŒä½åˆ—è¡¨ -->
            <template v-else>
              <div
                v-for="(job, idx) in filteredJobs"
                :key="job.id"
                v-motion
                :initial="{ opacity: 0, y: 20 }"
                :enter="{ opacity: 1, y: 0, transition: { delay: Math.min(idx * 50, 500) } }"
                class="flex flex-col md:flex-row items-center justify-between p-8 rounded-[32px] bg-white border border-gray-100 hover:shadow-xl hover:shadow-gray-200/50 hover:border-blue-100 transition-all group relative cursor-pointer"
                role="button"
                tabindex="0"
                @click="openJobDetail(job)"
                @keydown.enter.prevent="openJobDetail(job)"
              >
              <div class="flex-1 mb-6 md:mb-0">
                <div class="flex items-center gap-4 mb-4">
                  <h3 class="text-[20px] font-bold text-[#0B2747] group-hover:text-[#006EFF] transition-colors">
                    {{ job.title }}
                  </h3>
                  <span class="px-3 py-1 bg-blue-50 text-[#006EFF] text-[12px] font-bold rounded-lg">
                    {{ job.salary }}
                  </span>
                </div>
                <div class="flex flex-wrap gap-4 text-[14px] text-gray-400">
                  <span class="flex items-center gap-1.5">
                    <Briefcase class="w-4 h-4" />
                    {{ job.dept }} / {{ job.type }}
                  </span>
                  <span class="flex items-center gap-1.5">
                    <MapPin class="w-4 h-4" />
                    {{ job.location }}
                  </span>
                  <span class="flex items-center gap-1.5">
                    <Clock class="w-4 h-4" />
                    {{ job.date }}
                  </span>
                </div>
                <p class="mt-4 text-[14px] text-gray-500 leading-relaxed max-w-[600px] line-clamp-1">
                  {{ job.desc }}
                </p>
              </div>
              <div class="flex items-center gap-4">
                <Button
                  class="h-12 px-8 bg-white border border-blue-100 text-[#006EFF] rounded-xl font-bold shadow-sm hover:bg-blue-50"
                  @click.stop="openJobDetail(job)"
                >
                  æŸ¥çœ‹è¯¦æƒ…
                </Button>
                <Button
                  @click.stop="sendEmail('hr@chetuoche.com')"
                  class="h-12 px-8 bg-[#006EFF] hover:bg-[#0058CC] text-white rounded-xl border-none font-bold shadow-lg shadow-blue-500/20 cursor-pointer"
                >
                  æŠ•é€’ç®€å†
                </Button>
              </div>
              </div>
            </template>
            
            <!-- ç©ºçŠ¶æ€ -->
            <div v-if="!loading && filteredJobs.length === 0" class="py-20 text-center text-gray-400">
              æš‚æ—¶æ²¡æœ‰è¯¥ç±»åˆ«çš„çƒ­æ‹›å²—ä½ï¼Œæ¢ä¸ªåˆ†ç±»çœ‹çœ‹å§ã€‚
            </div>
          </div>
        </div>
      </div>
    </section>

    <Dialog v-model="isJobDialogOpen">
      <DialogContent v-if="selectedJob" class="sm:max-w-[720px] bg-white rounded-[32px] p-0 overflow-hidden">
        <div class="p-10">
          <div class="flex items-start justify-between gap-6">
            <div>
              <div class="text-[12px] text-[#006EFF] font-semibold bg-blue-50 inline-flex px-3 py-1 rounded-full mb-4">
                {{ selectedJob.type || 'ç¤¾æ‹›' }}
              </div>
              <DialogHeader class="space-y-2">
                <DialogTitle class="text-[26px] font-bold text-[#0B2747]">
                  {{ selectedJob.title || 'èŒä½è¯¦æƒ…' }}
                </DialogTitle>
                <DialogDescription class="text-gray-500 text-[14px]">
                  {{ selectedJob.dept || 'æ‰€å±éƒ¨é—¨' }} Â· {{ selectedJob.location || 'å·¥ä½œåœ°ç‚¹å¾…å®š' }} Â· {{ selectedJob.date || '' }}
                </DialogDescription>
              </DialogHeader>
            </div>
            <div class="text-right">
              <div class="text-[18px] font-bold text-[#FF6B00]">
                {{ selectedJob.salary || 'è–ªèµ„é¢è®®' }}
              </div>
              <Button
                class="mt-4 h-10 px-6 bg-[#006EFF] hover:bg-[#0058CC] text-white rounded-xl border-none font-bold"
                @click="sendEmail('hr@chetuoche.com')"
              >
                ç«‹å³æŠ•é€’
              </Button>
            </div>
          </div>

          <div class="mt-8 space-y-6">
            <div v-if="selectedJob.desc" class="bg-[#F8F9FB] rounded-2xl p-6 text-[14px] text-gray-600 leading-relaxed whitespace-pre-line">
              {{ selectedJob.desc }}
            </div>

            <div v-if="selectedJob.duty" class="">
              <h4 class="text-[16px] font-bold text-[#0B2747] mb-3">å²—ä½èŒè´£</h4>
              <div class="text-[14px] text-gray-600 leading-relaxed whitespace-pre-line">
                {{ selectedJob.duty }}
              </div>
            </div>

            <div v-if="selectedJob.requirement" class="">
              <h4 class="text-[16px] font-bold text-[#0B2747] mb-3">ä»»èŒè¦æ±‚</h4>
              <div class="text-[14px] text-gray-600 leading-relaxed whitespace-pre-line">
                {{ selectedJob.requirement }}
              </div>
            </div>

            <div v-if="selectedJob.benefits" class="">
              <h4 class="text-[16px] font-bold text-[#0B2747] mb-3">ç¦åˆ©å¾…é‡</h4>
              <div class="text-[14px] text-gray-600 leading-relaxed whitespace-pre-line">
                {{ selectedJob.benefits }}
              </div>
            </div>

            <div v-if="!selectedJob.duty && !selectedJob.requirement && selectedJob.detailHtml" class="">
              <h4 class="text-[16px] font-bold text-[#0B2747] mb-3">èŒä½è¯¦æƒ…</h4>
              <div class="prose max-w-none prose-p:text-gray-600 prose-li:text-gray-600" v-html="selectedJob.detailHtml" />
            </div>
          </div>
        </div>
      </DialogContent>
    </Dialog>

    <!-- â“ Section D: FAQ -->
    <section class="py-24 bg-[#F8F9FB]">
      <div class="container mx-auto max-w-[900px] px-4">
        <div class="text-center mb-16">
          <h2 class="text-[32px] font-bold text-[#0B2747] mb-4">
            æ‹›è˜å¸¸è§é—®é¢˜
          </h2>
          <div class="w-16 h-1 bg-[#FF6B00] mx-auto rounded-full" />
        </div>

        <Accordion type="single" collapsible class="w-full space-y-4">
          <AccordionItem
            v-for="(faq, idx) in faqs"
            :key="idx"
            :value="`item-${idx + 1}`"
            class="bg-white border border-gray-100 rounded-[24px] px-8 overflow-hidden"
          >
            <AccordionTrigger :value="`item-${idx + 1}`" class="hover:no-underline py-6">
              <span class="text-[18px] font-bold text-[#0B2747] text-left">
                {{ faq.question }}
              </span>
            </AccordionTrigger>
            <AccordionContent :value="`item-${idx + 1}`" class="pb-8 text-gray-500 leading-relaxed">
              {{ faq.answer }}
            </AccordionContent>
          </AccordionItem>
        </Accordion>
      </div>
    </section>

    <!-- ğŸ“„ Global Footer Summary -->
    <footer class="py-20 bg-[#0B2747] text-white border-t border-white/5">
      <div class="container mx-auto max-w-[1200px] px-4 flex flex-col md:flex-row justify-between items-center gap-8">
        <div>
          <div class="text-[24px] font-black mb-4">
            è½¦æ‹–è½¦<span class="text-[#FF6B00]">.</span>
          </div>
          <p class="text-white/40 text-[14px]">
            è®©æ±½è½¦ç‰©æµæ›´ç®€å•ã€æ›´é«˜æ•ˆ
          </p>
        </div>
        <div class="flex gap-8 text-[14px] text-white/60">
          <span
            class="hover:text-white cursor-pointer transition-colors"
            @click="navigateToAbout"
          >
            å…³äºæˆ‘ä»¬
          </span>
          <span
            class="hover:text-white cursor-pointer transition-colors"
            @click="navigateToContact"
          >
            è”ç³»æˆ‘ä»¬
          </span>
          <span
            class="hover:text-white cursor-pointer transition-colors"
            @click="navigateToHome"
          >
            è¿”å›é¦–é¡µ
          </span>
        </div>
      </div>
    </footer>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import BreadcrumbNav from '@/components/common/BreadcrumbNav.vue'
import { getBreadcrumbsForRoute } from '@/config/breadcrumbs'
import { useBreadcrumbSchema, useFAQPageSchema } from '@/composables/useSchemaOrg'

useBreadcrumbSchema(getBreadcrumbsForRoute('/careers'))

const breadcrumbItems = getBreadcrumbsForRoute('/careers')
import { useRouter } from 'vue-router'
import { useHead } from '#app'
import {
  ChevronRight,
  Search,
  Rocket,
  Terminal,
  Gift,
  Briefcase,
  MapPin,
  Clock,
} from 'lucide-vue-next'
import Button from '@/components/ui/Button.vue'
import Input from '@/components/ui/Input.vue'
import Accordion from '@/components/ui/Accordion.vue'
import AccordionItem from '@/components/ui/AccordionItem.vue'
import AccordionTrigger from '@/components/ui/AccordionTrigger.vue'
import AccordionContent from '@/components/ui/AccordionContent.vue'
import Dialog from '@/components/ui/Dialog.vue'
import DialogContent from '@/components/ui/DialogContent.vue'
import DialogHeader from '@/components/ui/DialogHeader.vue'
import DialogTitle from '@/components/ui/DialogTitle.vue'
import DialogDescription from '@/components/ui/DialogDescription.vue'
import ImageWithFallback from '@/components/ImageWithFallback.vue'
import type { Job } from '@/types'

const router = useRouter()
const searchQuery = ref('')
const activeTab = ref('all')

interface JobRaw {
  [key: string]: unknown
}

interface PostTypeItem {
  postType?: string
  postTypeName?: string
  postTypeId?: number | string
  postList?: JobRaw[]
  _postTypeValue?: string
}

interface JobDetail extends Job {
  duty?: string
  requirement?: string
  benefits?: string
  detailHtml?: string
  raw: JobRaw
}

const pickString = (value: unknown, fallback = '') => {
  if (value === null || value === undefined) return fallback
  const text = String(value).trim()
  return text || fallback
}

const stripHtml = (value: string) => {
  if (!value) return ''
  return String(value)
    .replace(/<[^>]+>/g, ' ')
    .replace(/\s+/g, ' ')
    .trim()
}

const summarize = (value: string, limit = 90) => {
  if (!value) return ''
  const plain = stripHtml(value)
  if (plain.length <= limit) return plain
  return `${plain.slice(0, limit)}...`
}

const formatDateLabel = (value: unknown) => {
  const text = pickString(value)
  if (!text) return ''
  if (text.includes('å‘å¸ƒ')) return text
  const numeric = Number(text)
  if (!Number.isNaN(numeric) && numeric > 1000000000) {
    try {
      const date = new Date(numeric)
      if (!Number.isNaN(date.getTime())) {
        const year = date.getFullYear()
        const month = String(date.getMonth() + 1).padStart(2, '0')
        const day = String(date.getDate()).padStart(2, '0')
        return `${year}-${month}-${day}`
      }
    } catch (error) {
      // silently ignore date format errors
    }
  }
  return text
}

const normalizeJobs = (rows: JobRaw[]): JobDetail[] => {
  // é˜²å¾¡æ€§æ£€æŸ¥ï¼šç¡®ä¿ rows æ˜¯æ•°ç»„
  if (!Array.isArray(rows)) {
    
    return []
  }
  
  return rows.filter(row => row && typeof row === 'object').map((row, index) => {
    const title = pickString(row.postName || row.title || row.name, 'èŒä½åç§°å¾…å®š')
    const dept = pickString(
      row.dept || row.department || row.departmentName || row.postDepartment || row.postTypeName || row._postTypeLabel,
      'ç”¨äººéƒ¨é—¨å¾…å®š'
    )
    const type = pickString(row.type || row.recruitType || row.jobType, 'ç¤¾æ‹›')
    const location = pickString(row.location || row.workSite || row.workPlace || row.workAddress || row.city, 'å·¥ä½œåœ°ç‚¹å¾…å®š')
    const detailHtml = pickString(row.postRequirement || row.requirementHtml || row.jobDetail)
    const desc = pickString(
      row.desc || row.description || row.postDesc || row.brief || row.summary,
      detailHtml ? summarize(detailHtml) : ''
    )
    const date = formatDateLabel(row.publishTime || row.createTime || row.updateTime)
    const salaryMin = pickString(row.salaryMin || row.minSalary)
    const salaryMax = pickString(row.salaryMax || row.maxSalary)
    const salaryUnit = pickString(row.salaryUnit || row.salaryUnitName)
    const salary =
      salaryMin && salaryMax
        ? `${salaryMin}-${salaryMax}${salaryUnit ? ` ${salaryUnit}` : ''}`
        : pickString(row.salary || row.payRange || row.compensation, 'è–ªèµ„é¢è®®')
    const id = pickString(row.id || row.postId || row.code, `JOB-${String(index + 1).padStart(3, '0')}`)
    const category = pickString(row._postTypeValue || row.category, 'all')

    return {
      id,
      title,
      category,
      dept,
      type,
      location,
      desc,
      date,
      salary,
      duty: pickString(row.duty || row.responsibility || row.postDuty || row.jobDuty),
      requirement: pickString(row.requirement || row.requirements || row.qualifications || row.jobRequire),
      benefits: pickString(row.benefits || row.welfare || row.benefit),
      detailHtml,
      raw: row,
    }
  })
}

// --- State ---
const loading = ref(true)
const allJobs = ref<JobDetail[]>([])
const tabs = ref<Array<{ label: string; value: string }>>([{ label: 'å…¨éƒ¨', value: 'all' }])

// --- API Functions ---
const fetchJobs = async () => {
  loading.value = true
  
  try {
    const response = await $fetch('/api/home/getAllPost')
    
    // è§£æå“åº”ï¼šå…¼å®¹å¤šç§æ•°æ®ç»“æ„
    const res = response as Record<string, unknown>
    let root: Record<string, unknown> = {}
    
    // å°è¯•å¤šç§è§£æè·¯å¾„
    if (Array.isArray(res?.data) && res.data.length > 0) {
      root = res.data[0] as Record<string, unknown>
    } else if (Array.isArray(response) && (response as unknown[]).length > 0) {
      root = (response as unknown[])[0] as Record<string, unknown>
    } else if (res?.data && typeof res.data === 'object') {
      root = res.data as Record<string, unknown>
    } else if (res && typeof res === 'object') {
      root = res
    }
    
    const postTypeList = Array.isArray(root.postTypeList) ? (root.postTypeList as PostTypeItem[]) : []
    // è§£æèŒä½åˆ—è¡¨å’Œåˆ†ç±»
    const rows: JobRaw[] = []
    const parsedTabs: Array<{ label: string; value: string }> = [{ label: 'å…¨éƒ¨', value: 'all' }]
    
    postTypeList.forEach((typeItem, index) => {
      const label = pickString(typeItem.postType || typeItem.postTypeName, `ç±»å‹${index + 1}`)
      const value = `type-${typeItem.postTypeId ?? index + 1}`
      typeItem._postTypeValue = value
      
      parsedTabs.push({ label, value })
      
      const posts = Array.isArray(typeItem.postList) ? typeItem.postList : []
      
      posts.forEach((post) => {
        rows.push({ ...post, _postTypeLabel: label, _postTypeValue: value })
      })
    })
    
    // å…œåº•ï¼šå¦‚æœæ²¡æœ‰æ•°æ®ï¼Œå°è¯•å…¶ä»–è§£ææ–¹å¼
    if (rows.length === 0 && Array.isArray(response)) {
      rows.push(...(response as JobRaw[]))
    }
    
    allJobs.value = normalizeJobs(rows)
    tabs.value = parsedTabs
    
  } catch (error) {
    
    allJobs.value = []
    tabs.value = [{ label: 'å…¨éƒ¨', value: 'all' }]
  } finally {
    loading.value = false
  }
}

// é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
onMounted(() => {
  fetchJobs()
})

const filteredJobs = computed(() => {
  if (loading.value || !allJobs.value) return []
  
  let jobs = activeTab.value === 'all' ? allJobs.value : allJobs.value.filter((j) => j && j.category === activeTab.value)
  
  if (searchQuery.value) {
    jobs = jobs.filter(
      (j) =>
        j && (
          (j.title && j.title.includes(searchQuery.value)) ||
          (j.desc && j.desc.includes(searchQuery.value)) ||
          (j.dept && j.dept.includes(searchQuery.value))
        )
    )
  }
  
  return jobs.filter(j => j !== null && j !== undefined)
})

const evpItems = [
  {
    icon: Rocket,
    title: 'å¿«é€Ÿæˆé•¿',
    desc: 'ç½®èº«äºè¡Œä¸šé¢†å…ˆçš„æ•°å­—åŒ–æ‰˜è¿å¹³å°ï¼Œä½ å°†ç›´æ¥æ¥è§¦æœ€å‰æ²¿çš„ AI è°ƒåº¦ç®—æ³•ä¸ç‰©æµç§‘æŠ€ï¼Œä¸è¡Œä¸šé¡¶å°–å¤§ç‰›å…±äº‹ï¼Œå®ç°èŒä¸šç”Ÿæ¶¯çš„æŒ‡æ•°çº§è·ƒå‡ã€‚',
    bgClass: 'bg-[#F8F9FB]',
    iconBgClass: 'bg-blue-50 text-[#006EFF] group-hover:bg-[#006EFF] group-hover:text-white',
    iconClass: '',
  },
  {
    icon: Terminal,
    title: 'æŠ€æœ¯çº¯ç²¹',
    desc: 'æˆ‘ä»¬æ¨å´‡å·¥ç¨‹å¸ˆæ–‡åŒ–ï¼Œæ·±è€•ç½‘ç»œå®‰å…¨æŠ€æœ¯ã€‚ä½ å°†å‚ä¸æ‰“é€ é‡‘èçº§ç‰©æµæ•°æ®åº•åº§ï¼Œç»´æŠ¤é€šè¿‡å›½å®¶ä¸‰çº§ç­‰ä¿è®¤è¯çš„æ ¸å¿ƒç³»ç»Ÿï¼Œç”¨æŠ€æœ¯æå«æ•°æ®ä»·å€¼ã€‚',
    bgClass: 'bg-[#F0F4F8] border-blue-50',
    iconBgClass: 'bg-[#0B2747] text-white group-hover:bg-[#006EFF]',
    iconClass: '',
  },
  {
    icon: Gift,
    title: 'ç«äº‰æ€§å›æŠ¥',
    desc: 'æä¾›å…·æœ‰å¸‚åœºç«äº‰åŠ›çš„è–ªé…¬ä½“ç³»ï¼ŒåŒ…å«å¹´ç»ˆå¥–ä¸æœŸæƒ/è‚¡æƒæ¿€åŠ±ã€‚äº«å—å®Œå–„çš„äº”é™©ä¸€é‡‘ä¿éšœï¼Œè®©æ¯ä¸€ä»½ä»˜å‡ºéƒ½è·å¾—å¯¹ç­‰çš„å›æŠ¥ã€‚',
    bgClass: 'bg-[#FFF8F4] border-orange-50',
    iconBgClass: 'bg-orange-50 text-[#FF6B00] group-hover:bg-[#FF6B00] group-hover:text-white',
    iconClass: '',
  },
]

const faqs = [
  {
    question: 'è½¦æ‹–è½¦çš„é¢è¯•æµç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ',
    answer:
      'é€šå¸¸åŒ…å« 2-3 è½®æŠ€æœ¯/ä¸“ä¸šé¢è¯• + 1 è½® HR é¢è¯•ã€‚é¢è¯•å®˜å°†é‡ç‚¹è€ƒå¯Ÿå€™é€‰äººçš„è¡Œä¸šè®¤çŸ¥æ·±åº¦ä¸è§£å†³å¤æ‚é—®é¢˜çš„é€»è¾‘èƒ½åŠ›ã€‚å¦‚æœæ˜¯æŠ€æœ¯å²—ä½ï¼Œå¯èƒ½è¿˜åŒ…å«ä»£ç æµ‹è¯•æˆ–æ¶æ„æ¢è®¨ç¯èŠ‚ã€‚',
  },
  {
    question: 'æ˜¯å¦æ¥å—åº”å±Šç”Ÿå®ä¹ ï¼Ÿ',
    answer:
      'æ˜¯çš„ã€‚é€šè¿‡ â€˜æ™ºè¿ç”Ÿâ€™ è®¡åˆ’ï¼Œæˆ‘ä»¬é•¿æœŸå¼€æ”¾å®ä¹ å²—ä½ï¼Œç‰¹åˆ«æ¬¢è¿äº¤é€šç‰©æµä¸è®¡ç®—æœºç›¸å…³ä¸“ä¸šçš„åŒå­¦æŠ•é€’ã€‚å®ä¹ è¡¨ç°ä¼˜ç§€çš„åŒå­¦æœ‰æé«˜æ¦‚ç‡è·å¾—è½¬æ­£ Offerã€‚',
  },
  {
    question: 'å…¥èŒåçš„åŸ¹è®­ä½“ç³»æ˜¯æ€æ ·çš„ï¼Ÿ',
    answer:
      'æˆ‘ä»¬æœ‰å®Œå–„çš„"è½¦æ‹–è½¦å­¦é™¢"å†…è®­ä½“ç³»ï¼Œæ¶µç›–è¡Œä¸šçŸ¥è¯†æ™®åŠã€é€šç”¨èŒä¸šæŠ€èƒ½åŠä¸“é¡¹æŠ€æœ¯å·¥ä½œåŠã€‚æ¯ä¸€ä½å…¥èŒæ–°äººéƒ½ä¼šé…å¤‡ä¸€å"å¯¼å¸ˆï¼ˆMentorï¼‰"ï¼Œè´Ÿè´£å…¥èŒåçš„å·¥ä½œå¼•å¯¼ä¸æˆé•¿åé¦ˆã€‚',
  },
]

const navigateToHome = () => {
  router.push('/')
}

const navigateToAbout = () => {
  router.push('/about')
}

const navigateToContact = () => {
  router.push('/contact')
}

const sendEmail = (email: string) => {
  window.location.href = `mailto:${email}`
}

const getJobSchema = (job: Job) => {
  // å®‰å…¨è§£æåœ°ç‚¹ä¿¡æ¯
  const locationParts = job.location ? String(job.location).split('/') : []
  const addressLocality = locationParts.length > 0 ? locationParts[0].trim() : 'å¾…å®š'
  
  const schema = {
    '@context': 'https://schema.org/',
    '@type': 'JobPosting',
    title: job.title || 'èŒä½åç§°',
    description: job.desc || 'èŒä½æè¿°',
    identifier: {
      '@type': 'PropertyValue',
      name: 'CheTuoChe',
      value: job.id || 'unknown',
    },
    hiringOrganization: { '@id': 'https://www.ctcapp.com/#organization' },
    employmentType: 'FULL_TIME',
    jobLocation: {
      '@type': 'Place',
      address: {
        '@type': 'PostalAddress',
        addressLocality,
        addressRegion: 'å±±ä¸œ',
        addressCountry: 'CN',
      },
    },
  }
  return schema
}

const allJobSchemas = computed(() => {
  // åªåœ¨æœ‰æ•°æ®ä¸”ä¸åœ¨åŠ è½½ä¸­æ—¶ç”Ÿæˆ schema
  if (loading.value || !filteredJobs.value || filteredJobs.value.length === 0) {
    return []
  }
  return filteredJobs.value.map(job => getJobSchema(job))
})

const isJobDialogOpen = ref(false)
const selectedJob = ref<JobDetail | null>(null)

const openJobDetail = (job: JobDetail) => {
  selectedJob.value = job
  isJobDialogOpen.value = true
}

useFAQPageSchema(faqs.map(f => ({ question: f.question, answer: f.answer })))

useHead(() => ({
  script: allJobSchemas.value.length > 0 ? [
    {
      type: 'application/ld+json',
      children: JSON.stringify(allJobSchemas.value)
    }
  ] : []
}))
</script>
